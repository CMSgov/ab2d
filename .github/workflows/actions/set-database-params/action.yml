name: "Set AWS Params in AB2D Account"
description: "Composite action to set environment variables from AWS parameters in AB2D account"
inputs:
  aws_region:
    description: "AWS region to use"
    required: true
  environment:
    description: "AB2D environment"
    required: true
    type: choice
    options:
      - dev
      - test
      - sandbox
      - prod
runs:
  using: "composite"
  steps:
    - name: Set env vars from AWS params in AB2D account
      uses: cmsgov/ab2d-bcda-dpc-platform/actions/aws-params-env-action@main
      env:
        AWS_REGION: ${{ inputs.aws_region }}
        MODULE_DB_PREFIX: /ab2d/core/${{ inputs.environment }}
      with:
        params: |
          DB_ENDPOINT=${{ env.MODULE_DB_PREFIX }}/core/nonsensitive/database_endpoint
          PGUSER=${{ env.MODULE_DB_PREFIX }}/core/sensitive/database_user
          PGPASSWORD=${{ env.MODULE_DB_PREFIX }}/core/sensitive/database_password

    - name: Add PG environment variables
      run: |
        PGHOST=$(echo $DB_ENDPOINT | cut -d ":" -f1)
        PGPORT=$(echo $DB_ENDPOINT | cut -d ":" -f2)
        echo "PGHOST=$PGHOST" >> $GITHUB_ENV
        echo "PGPORT=$PGPORT" >> $GITHUB_ENV
        echo "PGDATABASE=${{ inputs.environment }}" >> $GITHUB_ENV
        echo "DATABASE_SCHEMA_NAME=public" >> $GITHUB_ENV
        

        
